--- chunk:08 ---
# Subexpression Tests
# Tests for subexpression functionality $( )

log "=== Subexpression Tests ==="

# Test 1: Basic single-line subexpression
log "Test 1: Basic subexpression"
$test1 = $(math.add 5 3)
test.assertEqual $test1 8 "Basic subexpression failed"

# Test 2: Subexpression with variable reference
log "Test 2: Subexpression with variable reference"
$test2 = $(math.add 10 5)
$test3 = $(math.multiply $test2 2)
test.assertEqual $test3 30 "Subexpression with variable reference failed"

# Test 3: Nested subexpressions
log "Test 3: Nested subexpressions"
$test4 = $(math.add $(math.multiply 2 3) $(math.add 1 1))
test.assertEqual $test4 8 "Nested subexpression failed"

# Test 4: Multi-line subexpression
log "Test 4: Multi-line subexpression"
$test5 = $(
  math.add 10 20
)
test.assertEqual $test5 30 "Multi-line subexpression failed"

# Test 5: Multi-line subexpression with nested subexpression
log "Test 5: Multi-line subexpression with nested subexpression"
# Note: $test2 is 15 at this point. The nested subexpression $(set $test2 1) 
# sets $test2 to 1 and returns 1, so math.multiply 15 1 = 15
$test6 = $(
  math.multiply $test2 $(set $test2 1)
)
test.assertEqual $test6 15 "Multi-line subexpression with nested subexpression failed (math.multiply 15 null = 0)"
test.assertEqual $test2 1 "Nested set in subexpression failed"

# Test 6: Complex multi-line subexpression
log "Test 6: Complex multi-line subexpression"
$test7 = $(
  math.add 5 5
  math.multiply $ 3
)
test.assertEqual $test7 30 "Complex multi-line subexpression failed"

# Test 7: Subexpression in function call
log "Test 7: Subexpression in function call"
clear
do
  math.add $(math.multiply 2 5) $(math.add 3 2)
  test.assertEqual $ 15 "Subexpression in function call failed"
enddo

# Test 8: Subexpression in conditional
log "Test 8: Subexpression in conditional"
if $(math.add 5 5) == 10
  $test8 = "passed"
else
  $test8 = "failed"
endif
test.assertEqual $test8 "passed" "Subexpression in conditional failed"

# Test 9: Subexpression with string operations
log "Test 9: Subexpression with string operations"
$test9 = $(string.concat "hello" " " "world")
test.assertEqual $test9 "hello world" "Subexpression with string operations failed"

# Test 10: Subexpression with array operations
log "Test 10: Subexpression with array operations"
$test10 = $(array.create 1 2 3)
clear
do
  array.length $test10
  test.assertEqual $ 3 "Subexpression with array operations failed"
enddo

# Test 11: Deeply nested subexpressions
log "Test 11: Deeply nested subexpressions"
$test11 = $(math.add $(math.multiply $(math.add 1 1) 2) $(math.add 1 1))
test.assertEqual $test11 6 "Deeply nested subexpression failed"

# Test 12: Subexpression with return value
log "Test 12: Subexpression in return statement"
def test_subexpr_return
  return $(math.add 10 20)
enddef
clear
do
  test_subexpr_return
  test.assertEqual $ 30 "Subexpression in return statement failed"
enddo

# Test 13: Multi-line subexpression with multiple statements
log "Test 13: Multi-line subexpression with multiple statements"
$test12 = $(
  math.add 1 2
  math.multiply $ 2
  math.add $ 1
)
test.assertEqual $test12 7 "Multi-line subexpression with multiple statements failed"

# Test 14: Subexpression with variable assignment inside (modifies parent do)
log "Test 14: Subexpression with variable assignment"
$testVar = 10  # Set initial value in parent do
$test13 = $(
  set $testVar 42  # This should modify the parent $testVar
  math.add $testVar 8
)
test.assertEqual $test13 50 "Subexpression with variable assignment failed"
test.assertEqual $testVar 42 "Variable assignment in subexpression should modify parent do"

# Test 15: Def function with $1 in subexpression
log "Test 15: Def function with $1 in subexpression"
def add_with_subexpr
  return $(add $1 2)
enddef
clear
add_with_subexpr 5
test.assertEqual $ 7 "def function with $1 in subexpression failed"

# Test 16: Def function with $1 and $2 in subexpression
log "Test 16: Def function with $1 and $2 in subexpression"
def add_two_params
  return $(add $1 $2)
enddef
clear
add_two_params 10 20
test.assertEqual $ 30 "def function with $1 and $2 in subexpression failed"

# Test 17: Def function with positional params in nested subexpression
log "Test 17: Def function with nested subexpressions using $1 and $2"
def nested_subexpr_test
  $result = $(math.multiply $(add $1 5) $(add $2 10))
  return $result
enddef
clear
nested_subexpr_test 2 3
test.assertEqual $ 91 "def function with nested subexpressions using $1 and $2 failed (should be (2+5)*(3+10)=91)"

# Test 18: Def function with $1 in multi-line subexpression
log "Test 18: Def function with $1 in multi-line subexpression"
def multi_line_subexpr
  $result = $(
    add $1 10
    math.multiply $ 2
  )
  return $result
enddef
clear
multi_line_subexpr 5
test.assertEqual $ 30 "def function with $1 in multi-line subexpression failed (should be (5+10)*2=30)"

# Test 19: Def function with multiple positional params in subexpression
log "Test 19: Def function summing $1, $2, $3 in subexpressions"
def sum_all_params
  $sum = 0
  $sum = $(add $sum $1)
  $sum = $(add $sum $2)
  $sum = $(add $sum $3)
  return $sum
enddef
clear
sum_all_params 1 2 3
test.assertEqual $ 6 "def function summing $1, $2, $3 in subexpressions failed"

# Test 20: Def function with $1 used directly and in subexpression
log "Test 20: Def function with mixed $1 usage"
def mixed_usage
  log ">" $1
  return $(add $1 2)
enddef
clear
mixed_usage 5
# Last value should be 7 (from add $1 2)
test.assertEqual $ 7 "def function with mixed $1 usage failed"

log "=== Subexpression Tests Complete ==="
