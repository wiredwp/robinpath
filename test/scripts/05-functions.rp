# Function Tests
# Tests for def functions, return statements, and parameters

log "=== Function Tests ==="

# Test 1: Basic user-defined function
log "Test 1: Basic user-defined function"
def greet
  log "Test 1 - Hello" $1
  log "Test 1 - Your age is" $2
  math.add $2 1
enddef

greet "Alice" 25
test.assertEqual $ 26 "Basic function failed"

# Test 2: Function with return value
log "Test 2: Function with return value"
def sum_and_double
  math.add $1 $2
  math.multiply $ 2
enddef

sum_and_double 10 20
test.assertEqual $ 60 "Function with return value failed"

# Test 3: Return statement in functions
log "Test 3: Return statement in functions"
def return_value
  return 100
  log "This should not execute"
enddef

clear
do
  return_value
  test.assertEqual $ 100 "Function return value failed"
enddo

def return_variable
  $result = 200
  return $result
  log "This should not execute"
enddef

clear
do
  return_variable
  test.assertEqual $ 200 "Function return variable failed"
enddo

def return_expression
  math.add 10 20
  return $
  log "This should not execute"
enddef

clear
do
  return_expression
  test.assertEqual $ 30 "Function return expression failed"
enddo

def return_early
  if true
    return "early"
  endif
  log "This should not execute"
enddef

clear
do
  return_early
  test.assertEqual $ "early" "Function early return failed"
enddo

def return_no_value
  $temp = 50
  return
  log "This should not execute"
enddef

clear
do
  return_no_value
  test.assertEqual $ null "Function return last value failed"
enddo

# Test 4: Return with different value types
log "Test 4: Return with different types"
def return_string
  return "hello"
enddef

clear
do
  return_string
  test.assertEqual $ "hello" "Return string failed"
enddo

def return_number
  return 42
enddef

clear
do
  return_number
  test.assertEqual $ 42 "Return number failed"
enddo

def return_boolean
  return true
enddef

clear
do
  return_boolean
  test.assertEqual $ true "Return boolean failed"
enddo

def return_null
  return null
enddef

clear
do
  return_null
  test.assertEqual $ null "Return null failed"
enddo

# Test 5: Return in loops
log "Test 5: Return in loops"
def return_in_for
  for $i in range 1 10
    if $i == 3
      return $i
    endif
  endfor
  return 0
enddef

clear
do
  return_in_for
  test.assertEqual $ 3 "Return in for loop failed"
enddo

# Test 7: Function parameters and arguments
log "Test 7: Function parameters and arguments"
def greetLog $name $age
  log "Test 7 - Hello" $name
  log "Test 7 - Age:" $age
  log "Test 7 - Positional 1:" $1
  log "Test 7 - Positional 2:" $2
enddef

clear
do
  greetLog("Alice" 25)
  test.assertNull $ "Function with param names - basic call failed"
enddo

# Test 8: Parameter name aliases
log "Test 8: Parameter name aliases"
def add $a $b
  math.add $a $b
enddef

clear
do
  add(10 20)
  test.assertEqual $ 30 "Function param aliases failed"
enddo

# Test 9: Function with more args than declared params
log "Test 9: Function with extra args"
def first $a
  log "Test 9 - a:" $a
  log "Test 9 - extra:" $2
enddef

clear
do
  first(10 20)
  test.assertEqual $ null "Function with extra args failed"
enddo

# Test 10: Function with fewer args than declared params
log "Test 10: Function with fewer args"
def three $a $b $c
  log "Test 10 - a:" $a
  log "Test 10 - b:" $b
  log "Test 10 - c:" $c
enddef

clear
do
  three(10 20)
  test.assertEqual $ null "Function with fewer args failed"
enddo

# Test 11: Named arguments
log "Test 11: Named arguments"
def config $env
  log "Test 11 - env:" $env
  log "Test 11 - key:" $args.key
  log "Test 11 - value:" $args.value
enddef

clear
do
  config("production" key="api-key" value="secret123")
  test.assertEqual $ null "Function with named args failed"
enddo

# Test 12: Named arguments with $paramName=value syntax
log "Test 12: Named arguments with $paramName=value syntax"
def test_fn $a $b
  string.concat $a $b
enddef

test_fn $a="hello" $b="world"
test.assertEqual $ "helloworld" "CLI-style $paramName=value failed"

test_fn($a="foo" $b="bar")
test.assertEqual $ "foobar" "Parenthesized $paramName=value failed"

# Test 13: Def blocks extracted first (functions can reference each other)
log "Test 13: Def blocks extracted first"
def fn
  fn2
  $result1 = $
  fn3
  $result2 = $
  math.add $result1 $result2
enddef

def fn2
  return 10
enddef

def fn3
  return 20
enddef

clear
do
  fn
  test.assertEqual $ 30 "Def blocks extracted first - fn should be able to call fn2 and fn3"
enddo

clear
do
  fn2
  test.assertEqual $ 10 "Def blocks extracted first - fn2 should be callable"
enddo

clear
do
  fn3
  test.assertEqual $ 20 "Def blocks extracted first - fn3 should be callable"
enddo

# Test 14: Multi-line function calls with arguments on separate lines (no commas)
log "Test 14: Multi-line function calls"
def test_multiline $a $b
  math.add $a $b
enddef

clear
do
  test_multiline(
    5
    5
  )
  test.assertEqual $ 10 "Multi-line function call failed"
enddo

clear
do
  math.add(
    10
    20
  )
  test.assertEqual $ 30 "Multi-line math.add call failed"
enddo

# Test 15: Single-line function calls with space-separated arguments (no commas)
log "Test 15: Space-separated arguments"
def test_spaces $a $b
  math.add $a $b
enddef

clear
do
  test_spaces(5 5)
  test.assertEqual $ 10 "Space-separated function call failed"
enddo

clear
do
  math.add(5 5)
  test.assertEqual $ 10 "Space-separated math.add call failed"
enddo

# Test 16: Named arguments with = syntax (multi-line)
log "Test 16: Named arguments with = syntax"
def test_named $a $b
  string.concat $a $b
enddef

clear
do
  test_named(
    a="abc"
    b="def"
  )
  test.assertEqual $ "abcdef" "Multi-line named arguments failed"
enddo

clear
do
  test_named(
    $a="hello"
    $b="world"
  )
  test.assertEqual $ "helloworld" "Multi-line named arguments with $ prefix failed"
enddo

# Test 17: Named arguments with = syntax (single-line)
log "Test 17: Single-line named arguments"
clear
do
  test_named(a="foo" b="bar")
  test.assertEqual $ "foobar" "Single-line named arguments failed"
enddo

clear
do
  test_named($a="x" $b="y")
  test.assertEqual $ "xy" "Single-line named arguments with $ prefix failed"
enddo

# Test 18: Mixed positional and named arguments
log "Test 18: Mixed positional and named arguments"
def test_mixed $a $b $c
  log "---->" $a $b $c
  string.concat $a $b
  string.concat $ $c
enddef

clear
do
  test_mixed(
    "hello"
    $c="world"
  )
  test.assertEqual $ "helloworld" "Mixed positional and named arguments failed"
enddo

# Test 19: define as alias for def
log "Test 19: define as alias for def"
define test_define_alias
  return "define works"
enddef

clear
do
  test_define_alias
  test.assertEqual $ "define works" "define alias for def failed"
enddo

define test_define_with_params $a $b
  math.add $a $b
enddef

clear
do
  test_define_with_params(10 20)
  test.assertEqual $ 30 "define with parameters failed"
enddo

define test_define_return
  return 42
enddef

clear
do
  test_define_return
  test.assertEqual $ 42 "define with return failed"
enddo

# Test 20: Optional "as" keyword after parameters
log "Test 20: Optional 'as' keyword after parameters"
def test_as_keyword $x $y as
  math.add $x $y
enddef

clear
do
  test_as_keyword(5 10)
  test.assertEqual $ 15 "def with 'as' keyword after parameters failed"
enddo

def test_as_keyword_no_params as
  return "no params with as"
enddef

clear
do
  test_as_keyword_no_params
  test.assertEqual $ "no params with as" "def with 'as' keyword and no params failed"
enddo

define test_define_with_as $a $b as
  math.multiply $a $b
enddef

clear
do
  test_define_with_as(3 4)
  test.assertEqual $ 12 "define with 'as' keyword after parameters failed"
enddo

def test_as_with_comment $value as # this is a comment
  return $value
enddef

clear
do
  test_as_with_comment(99)
  test.assertEqual $ 99 "def with 'as' and comment failed"
enddo


# Test multi-line object literal as function argument (direct)
clear
do
  get {
    name: "Test",
    value: 100,
    active: true
  } "name"
  test.assertEqual $ "Test" "Multi-line object as function argument (direct) failed"
enddo

# Test multi-line object literal as function argument (via variable)
clear
do
  get {
    name: "Test",
    value: 100,
    active: true
  } "name"
  test.assertEqual $ "Test" "Multi-line object as function argument (via variable) failed"
enddo

# Test multi-line array literal as function argument
clear
do
  array.length [
    10,
    20,
    30,
    40
  ]
  test.assertEqual $ 4 "Multi-line array as function argument failed"
enddo

# Test multi-line object literal in parenthesized call
clear
do
  get({
    id: 123,
    status: "active"
  } "id")
  test.assertEqual $ 123 "Multi-line object in parenthesized call failed"
enddo

# Test multi-line array literal in parenthesized call
clear
do
  array.length([
    "one",
    "two",
    "three"
  ])
  test.assertEqual $ 3 "Multi-line array in parenthesized call failed"
enddo

def defObjectTest
  log $1
  test.assertEqual $1.hello "world" "Function should accept object argument in $1 $2"
enddef

defObjectTest {
  hello: "world"
}

# Test 21: Object literal as named argument with $param= syntax
log "Test 21: Object literal as named argument"
def testObjNamed $obj
  test.assertEqual $obj.name "Alice" "Object as named argument failed"
  test.assertEqual $obj.age 30 "Object property access in named arg failed"
enddef

clear
do
  testObjNamed $obj={
    name: "Alice",
    age: 30
  }
  test.assertEqual $ null "Object literal as named argument with $param= failed"
enddo

# Test 22: Array literal as named argument with $param= syntax
log "Test 22: Array literal as named argument"
def testArrNamed $arr
  array.length $arr
enddef

clear
do
  testArrNamed $arr=[1, 2, 3, 4, 5]
  test.assertEqual $ 5 "Array literal as named argument with $param= failed"
enddo

# Test 23: Object literal in parenthesized call with named argument
log "Test 23: Object in parenthesized call with named argument"
def testObjParen $data
  test.assertEqual $data.id 123 "Object in parenthesized call failed"
  test.assertEqual $data.status "active" "Object property in parenthesized call failed"
enddef

clear
do
  testObjParen($data={
    id: 123,
    status: "active"
  })
  test.assertEqual $ null "Object in parenthesized call with named arg failed"
enddo

# Test 24: Array literal in parenthesized call with named argument
log "Test 24: Array in parenthesized call with named argument"
def testArrParen $items
  array.length $items
enddef

clear
do
  testArrParen($items=["a", "b", "c"])
  test.assertEqual $ 3 "Array in parenthesized call with named arg failed"
enddo

# Test 25: Multiple objects as arguments (positional)
log "Test 25: Multiple objects as positional arguments"
def testMultiObj $obj1 $obj2
  test.assertEqual $obj1.key "first" "First object argument failed"
  test.assertEqual $obj2.key "second" "Second object argument failed"
enddef

clear
do
  testMultiObj {
    key: "first"
  } {
    key: "second"
  }
  test.assertEqual $ null "Multiple objects as positional args failed"
enddo

# Test 26: Multiple arrays as arguments (positional)
log "Test 26: Multiple arrays as positional arguments"
def testMultiArr $arr1 $arr2
  array.length $arr1
  $len1 = $
  array.length $arr2
  $len2 = $
  math.add $len1 $len2
enddef

clear
do
  testMultiArr [1, 2] [3, 4, 5]
  test.assertEqual $ 5 "Multiple arrays as positional args failed"
enddo

# Test 27: Object and array mixed as positional arguments
log "Test 27: Object and array mixed as positional arguments"
def testMixedObjArr $obj $arr
  test.assertEqual $obj.name "Test" "Object in mixed args failed"
  array.length $arr
  test.assertEqual $ 3 "Array in mixed args failed"
enddef

clear
do
  testMixedObjArr {
    name: "Test"
  } ["x", "y", "z"]
  test.assertEqual $ 3 "Object and array mixed as positional args failed"
enddo

# Test 28: Object as positional, array as named argument
log "Test 28: Object positional, array as named argument"
def testObjPosArrNamed $obj $arr
  test.assertEqual $obj.id 100 "Positional object failed"
  array.length $arr
  test.assertEqual $ 2 "Named array argument failed"
enddef

clear
do
  testObjPosArrNamed {
    id: 100
  } $arr=["one", "two"]
  test.assertEqual $ 2 "Object positional with array named arg failed"
enddo

# Test 29: Array as positional, object as named argument
log "Test 29: Array positional, object as named argument"
def testArrPosObjNamed $arr $obj
  array.length $arr
  test.assertEqual $ 2 "Positional array failed"
  test.assertEqual $obj.value 200 "Named object argument failed"
enddef

clear
do
  testArrPosObjNamed [10, 20] $obj={
    value: 200
  }
  test.assertEqual $ 2 "Array positional with object named arg failed"
enddo

# Test 30: Multiple named arguments with objects and arrays
log "Test 30: Multiple named arguments with objects and arrays"
def testMultiNamed $config $items $metadata
  test.assertEqual $config.env "prod" "First named object failed"
  array.length $items
  test.assertEqual $ 4 "Named array failed"
  test.assertEqual $metadata.version "1.0" "Second named object failed"
  return $metadata.version 
enddef

clear
do
  testMultiNamed $config={
    env: "prod",
    debug: false
  } $items=[1, 2, 3, 4] $metadata={
    version: "1.0",
    author: "test"
  }
  test.assertEqual $ "1.0" "Multiple named args with objects/arrays failed"
enddo

# Test 31: Object in parenthesized call with multiple named arguments
log "Test 31: Object in parenthesized call with multiple named args"
def testObjParenMulti $data $options $flags
  test.assertEqual $data.name "User" "Object in parenthesized multi-named failed"
  test.assertEqual $options.count 5 "Second named object failed"
  test.assertEqual $flags.enabled true "Third named object failed"
enddef

clear
do
  testObjParenMulti($data={
    name: "User",
    id: 1
  } $options={
    count: 5,
    limit: 10
  } $flags={
    enabled: true,
    visible: false
  })
enddo

# Test 32: Array in parenthesized call with multiple named arguments
log "Test 32: Array in parenthesized call with multiple named args"
def testArrParenMulti $primary $secondary $tertiary
  array.length $primary
  $p = $
  array.length $secondary
  $s = $
  array.length $tertiary
  $t = $
  math.add $p $s
  math.add $ $t
enddef

clear
do
  testArrParenMulti($primary=[1, 2] $secondary=[3, 4, 5] $tertiary=[6, 7, 8, 9])
  test.assertEqual $ 9 "Array in parenthesized call with multiple named args failed"
enddo

# Test 33: Mixed positional and named with objects/arrays
log "Test 33: Mixed positional and named with objects/arrays"
def testMixedComplex $first $second $third
  test.assertEqual $first.type "object" "First positional object failed"
  array.length $second
  test.assertEqual $ 3 "Second positional array failed"
  test.assertEqual $third.key "named" "Named object argument failed"
  return $third.key 
enddef

clear
do
  testMixedComplex {
    type: "object"
  } ["a", "b", "c"] $third={
    key: "named",
    value: 42
  }
  test.assertEqual $ "named" "Mixed positional and named with objects/arrays failed"
enddo

# Test 34: Nested objects in function arguments
log "Test 34: Nested objects in function arguments"
def testNestedObj $data
  test.assertEqual $data.user.name "John" "Nested object property access failed"
  test.assertEqual $data.user.age 25 "Nested object second property failed"
  test.assertEqual $data.settings.theme "dark" "Deeply nested property failed"
  return $data.settings.theme 
enddef

clear
do
  testNestedObj {
    user: {
      name: "John",
      age: 25
    },
    settings: {
      theme: "dark",
      lang: "en"
    }
  }
  test.assertEqual $ "dark" "Nested objects in function arguments failed"
enddo

# Test 35: Nested arrays in function arguments
log "Test 35: Nested arrays in function arguments"
def testNestedArr $matrix
  array.length $matrix
  test.assertEqual $ 2 "Outer array length failed"
  array.get $matrix 0
  $row1 = $
  array.length $row1
  test.assertEqual $ 3 "Inner array length failed"
enddef

clear
do
  testNestedArr [
    [1, 2, 3],
    [4, 5, 6]
  ]
  test.assertEqual $ 3 "Nested arrays in function arguments failed"
enddo

# Test 36: Object with array values as named argument
log "Test 36: Object with array values as named argument"
def testObjWithArr $config
  test.assertEqual $config.name "Config" "Object property failed"
  array.length $config.items
  test.assertEqual $ 3 "Array property in object failed"
enddef

clear
do
  testObjWithArr $config={
    name: "Config",
    items: ["x", "y", "z"],
    count: 3
  }
  test.assertEqual $ 3 "Object with array values as named argument failed"
enddo

# Test 37: Array with object elements as named argument
log "Test 37: Array with object elements as named argument"
def testArrWithObj $users
  array.length $users
  test.assertEqual $ 2 "Array length failed"
  array.get $users 0
  $user1 = $
  test.assertEqual $user1.name "Alice" "Object element in array failed"
  return $user1.name
enddef

clear
do
  testArrWithObj $users=[
    { name: "Alice", id: 1 },
    { name: "Bob", id: 2 }
  ]
  test.assertEqual $ "Alice" "Array with object elements as named argument failed"
enddo

# Test 38: Complex multi-line object with named argument in parenthesized call
log "Test 38: Complex multi-line object with named argument"
def testComplexObj $payload
  test.assertEqual $payload.request.method "POST" "Nested object property failed"
  array.length $payload.request.headers
  test.assertEqual $ 2 "Array in nested object failed"
  test.assertEqual $payload.response.status 200 "Deeply nested property failed"
  return $payload.response.status 
enddef

clear
do
  testComplexObj($payload={
    request: {
      method: "POST",
      url: "/api",
      headers: [
        "Content-Type: application/json",
        "Authorization: Bearer token"
      ]
    },
    response: {
      status: 200,
      body: "success"
    }
  })
  test.assertEqual $ 200 "Complex multi-line object with named argument failed"
enddo

# Test 39: Space-separated object with named argument
log "Test 39: Space-separated object with named argument"
def testSpaceObj $data
  test.assertEqual $data.key "value" "Space-separated object named arg failed"
  return $data.num
enddef

clear
do
  testSpaceObj $data={ key: "value", num: 42 }
  test.assertEqual $ 42 "Space-separated object with named argument failed"
enddo

# Test 40: Space-separated array with named argument
log "Test 40: Space-separated array with named argument"
def testSpaceArr $list
  array.length $list
enddef

clear
do
  testSpaceArr $list=[1, 2, 3, 4]
  test.assertEqual $ 4 "Space-separated array with named argument failed"
enddo


log "=== Function Tests Complete ==="
