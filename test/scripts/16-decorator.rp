
log "=== Prerequisite Tests Complete ==="
log ""

# Test 1: Built-in decorator functionality for functions
log "Test 1: Built-in decorators for functions"
@desc "A test function with description"
def testDescFn
  log "Test 1.1 - Function with @desc decorator"
enddef

testDescFn
getMeta testDescFn description
test.assertEqual $ "A test function with description" "@desc decorator failed to add description metadata"

@description "Another test function"
def testDescriptionFn
  log "Test 1.2 - Function with @description decorator"
enddef

testDescriptionFn
getMeta testDescriptionFn description
test.assertEqual $ "Another test function" "@description decorator failed to add description metadata"

@title "Test Function Title"
def testTitleFn
  log "Test 1.3 - Function with @title decorator"
enddef

testTitleFn
getMeta testTitleFn title
test.assertEqual $ "Test Function Title" "@title decorator failed to add title metadata"

@desc "Function with both description and title"
@title "Multi Decorator Function"
def multiDecoratorFn
  log "Test 1.4 - Function with multiple decorators"
enddef

multiDecoratorFn
getMeta multiDecoratorFn description
test.assertEqual $ "Function with both description and title" "Multiple decorators - description failed"
getMeta multiDecoratorFn title
test.assertEqual $ "Multi Decorator Function" "Multiple decorators - title failed"

# Test 2: Decorators for var and const
log "Test 2: Decorators for var and const"
@desc "A test variable with description"
var $decoratedVar2a 42
test.assertEqual $decoratedVar2a 42 "decorated var value failed"
getMeta $decoratedVar2a description
test.assertEqual $ "A test variable with description" "@desc decorator with var failed"

@title "Test Variable Title"
var $titledVar2b 100
test.assertEqual $titledVar2b 100 "titled var value failed"
getMeta $titledVar2b title
test.assertEqual $ "Test Variable Title" "@title decorator with var failed"

@desc "A test constant with description"
const $DECORATED_CONST_2c 300
test.assertEqual $DECORATED_CONST_2c 300 "decorated const value failed"
getMeta $DECORATED_CONST_2c description
test.assertEqual $ "A test constant with description" "@desc decorator with const failed"

# Test 3: @param decorator
log "Test 3: @param decorator"
@param string $name "User's name"
@desc "Function with parameter metadata"
def greetUser
  log "Hello" $1
enddef

greetUser "Alice"
getMeta greetUser parameters
$params3a = $
test.assertType $params3a "array" "getMeta parameters should return array"
test.assertEqual $params3a[0].name "name" "@param decorator - parameter name failed"
test.assertEqual $params3a[0].dataType "string" "@param decorator - dataType failed"
test.assertEqual $params3a[0].description "User's name" "@param decorator - description failed"
test.assertTrue $params3a[0].required "@param decorator - required should be true when no default"

@param number $age 25 "User's age"
@desc "Function with parameter with default"
def setAge
  log "Age:" $1
enddef

setAge 30
getMeta setAge parameters
$params3b = $
test.assertEqual $params3b[0].name "age" "@param decorator - parameter name with default failed"
test.assertEqual $params3b[0].dataType "number" "@param decorator - dataType with default failed"
test.assertEqual $params3b[0].defaultValue 25 "@param decorator - defaultValue failed"
test.assertFalse $params3b[0].required "@param decorator - required should be false when default provided"

# Test 4: @arg decorator
log "Test 4: @arg decorator"
@arg number
@desc "Function with variadic arguments"
def addNumbers
  math.add $1 $2 $3
enddef

addNumbers 1 2 3
getMeta addNumbers parameters
$params4 = $
test.assertType $params4 "array" "getMeta parameters should return array"
# Find args parameter
$argsParam4 = null
for $p in $params4
  if $p.name == "args"
    set $argsParam4 $p
    break
  endif
endfor
test.assertNotNull $argsParam4 "@arg decorator - args parameter should exist"
test.assertEqual $argsParam4.name "args" "@arg decorator - args parameter name failed"
test.assertEqual $argsParam4.dataType "array" "@arg decorator - args parameter dataType failed"

# Test 5: @required decorator
log "Test 5: @required decorator"
@param string $name "User name"
@required $name
@desc "Function with required parameter"
def greetRequired
  log "Hello" $1
enddef

greetRequired "Alice"
getMeta greetRequired parameters
$params5 = $
test.assertType $params5 "array" "getMeta parameters should return array"
test.assertEqual $params5[0].name "name" "@required decorator - parameter name failed"
test.assertTrue $params5[0].required "@required decorator - parameter should be required"

# Test 6: Decorators for if, do, for, on statements
log "Test 6: Decorators for other statements"
@desc "This is a conditional block"
@title "Conditional Test"
if true
  log "Test 6.1 - If block with decorators"
endif

@desc "This is a do block"
@title "Do Block Test"
do
  log "Test 6.2 - Do block with decorators"
enddo

@desc "This is a for loop"
@title "For Loop Test"
for $i in range 1 3
  log "Test 6.3 - For loop with decorators, iteration:" $i
endfor

@desc "This is an event handler"
@title "Event Handler Test"
on "testEvent"
  log "Test 6.4 - On block with decorators"
endon

log "=== Decorator Tests Complete ==="
