# RobinPath Test Script
# This script tests various features of the RobinPath interpreter

# Test 1: Basic math operations
math.add 10 20
$result
log "Test 1 - Addition result:" $result

math.multiply $result 5
log "Test 1 - Multiplication result:" $

# Test 2: Variable assignment
$balance = 100
log "Test 2 - Balance:" $balance

# Test 3: Inline conditional
if $balance > 0 then log "Test 3 - Balance is positive"

# Test 4: Block if with else
$score = 85
if $score >= 90
  log "Test 4 - Grade: A"
elseif $score >= 80
  log "Test 4 - Grade: B"
elseif $score >= 70
  log "Test 4 - Grade: C"
else
  log "Test 4 - Grade: F"
endif

# Test 5: User-defined function
def greet
$1
$2
log "Test 5 - Hello" $1
log "Test 5 - Your age is" $2
math.add $2 1
enddef

greet "Alice" 25
log "Test 5 - Next year age:" $

# Test 6: Function with return value
def sum_and_double
math.add $1 $2
math.multiply $ 2
enddef

sum_and_double 10 20
log "Test 6 - Sum and double result:" $

# Test 7: Nested conditionals
$value = 42
if $value > 0
  if $value < 50
    log "Test 7 - Value is between 0 and 50"
  else
    log "Test 7 - Value is 50 or greater"
  endif
else
  log "Test 7 - Value is negative or zero"
endif

# Test 8: Shorthand assignment
math.add 5 3
$sum
log "Test 8 - Shorthand assignment result:" $sum

# Test 9: Using last value ($)
math.add 7 8
math.multiply $ 2
log "Test 9 - Chained operations result:" $

# Test 10: Complex expression
$age = 18
$citizen = "yes"
if ($age >= 18) && ($citizen == "yes") then log "Test 10 - Loan approved"

# Test 11: For loop
for $i in range 1 5
  log "Test 11 - Loop iteration:" $i
endfor

# Test 12: Nested for loop
for $i in range 1 3
  for $j in range 1 2
    log "Test 12 - Nested loop:" $i $j
  endfor
endfor

# Test 13: For loop with array
$numbers = range 10 12
for $num in $numbers
  log "Test 13 - Number:" $num
endfor

# Test 14: For loop inside if
$count = 3
if $count > 0
  for $i in range 1 $count
    log "Test 14 - Conditional loop:" $i
  endfor
endif

# Test 15: If inside for loop
for $i in range 1 5
  if $i > 3
    log "Test 15 - Greater than 3:" $i
  endif
endfor

# Test 16: Math module tests
math.add 5 10
test.assertEqual $ 15 "Math.add failed"
math.add 1 2 3 4
test.assertEqual $ 10 "Math.add multiple args failed"
math.multiply 5 3
test.assertEqual $ 15 "Math.multiply failed"
math.multiply 2 3 4
test.assertEqual $ 24 "Math.multiply multiple args failed"
math.subtract 10 3
test.assertEqual $ 7 "Math.subtract failed"
math.divide 15 3
test.assertEqual $ 5 "Math.divide failed"
math.modulo 17 5
test.assertEqual $ 2 "Math.modulo failed"
math.power 2 8
test.assertEqual $ 256 "Math.power failed"
math.sqrt 16
test.assertEqual $ 4 "Math.sqrt failed"
math.abs -5
test.assertEqual $ 5 "Math.abs failed"
math.round 3.7
test.assertEqual $ 4 "Math.round failed"
math.floor 3.7
test.assertEqual $ 3 "Math.floor failed"
math.ceil 3.2
test.assertEqual $ 4 "Math.ceil failed"
math.min 5 2 8 1
test.assertEqual $ 1 "Math.min failed"
math.max 5 2 8 1
test.assertEqual $ 8 "Math.max failed"
log "Test 16 - Math module: All passed"

# Test 17: String module tests
string.length "hello"
test.assertEqual $ 5 "String.length failed"
string.substring "hello" 1 4
test.assertEqual $ "ell" "String.substring failed"
string.toUpperCase "hello"
test.assertEqual $ "HELLO" "String.toUpperCase failed"
string.toLowerCase "HELLO"
test.assertEqual $ "hello" "String.toLowerCase failed"
string.trim "  hello  "
test.assertEqual $ "hello" "String.trim failed"
string.replace "hello world" "world" "universe"
test.assertEqual $ "hello universe" "String.replace failed"
string.replaceAll "a b a" "a" "x"
test.assertEqual $ "x b x" "String.replaceAll failed"
string.split "a,b,c" ","
$splitArr = $
array.get $splitArr 0
test.assertEqual $ "a" "String.split first element failed"
string.startsWith "hello" "he"
test.assertTrue $ "String.startsWith failed"
string.endsWith "hello" "lo"
test.assertTrue $ "String.endsWith failed"
string.contains "hello" "ell"
test.assertTrue $ "String.contains failed"
string.indexOf "hello" "l"
test.assertEqual $ 2 "String.indexOf failed"
string.lastIndexOf "hello" "l"
test.assertEqual $ 3 "String.lastIndexOf failed"
string.charAt "hello" 1
test.assertEqual $ "e" "String.charAt failed"
string.padStart "5" 3 "0"
test.assertEqual $ "005" "String.padStart failed"
string.padEnd "5" 3 "0"
test.assertEqual $ "500" "String.padEnd failed"
string.repeat "ha" 3
test.assertEqual $ "hahaha" "String.repeat failed"
log "Test 17 - String module: All passed"

# Test 18: Array module tests
$arr = range 1 5
array.length $arr
test.assertEqual $ 5 "Array.length failed"
array.get $arr 2
test.assertEqual $ 3 "Array.get failed"
array.slice $arr 1 4
$sliced = $
array.length $sliced
test.assertEqual $ 3 "Array.slice length failed"
array.get $sliced 0
test.assertEqual $ 2 "Array.slice content failed"
array.push $arr 6
$pushed = $
array.length $pushed
test.assertEqual $ 6 "Array.push length failed"
array.get $pushed 5
test.assertEqual $ 6 "Array.push content failed"
$arr1 = range 1 2
$arr2 = range 3 4
array.concat $arr1 $arr2
$concatted = $
array.length $concatted
test.assertEqual $ 4 "Array.concat length failed"
array.get $concatted 0
test.assertEqual $ 1 "Array.concat content failed"
array.join $arr ","
test.assertEqual $ "1,2,3,4,5" "Array.join failed"
array.create 1 2 3
$created = $
array.length $created
test.assertEqual $ 3 "Array.create length failed"
array.get $created 0
test.assertEqual $ 1 "Array.create first element failed"
array.get $created 1
test.assertEqual $ 2 "Array.create second element failed"
array.get $created 2
test.assertEqual $ 3 "Array.create third element failed"
array.create "hello" "world" 42 true
$mixed = $
array.length $mixed
test.assertEqual $ 4 "Array.create mixed types length failed"
array.get $mixed 0
test.assertEqual $ "hello" "Array.create string element failed"
array.get $mixed 2
test.assertEqual $ 42 "Array.create number element failed"
array.get $mixed 3
test.assertEqual $ true "Array.create boolean element failed"
array.create
$emptyCreated = $
array.length $emptyCreated
test.assertEqual $ 0 "Array.create empty array failed"
log "Test 18 - Array module: All passed"

# Test 19: Json module tests
$jsonStr = '{"name": "John", "age": 30}'
json.parse $jsonStr
$parsed = $
test.assertNotNull $parsed "Json.parse failed"
json.stringify $parsed
$stringified = $
string.contains $stringified "John"
test.assertTrue $ "Json.stringify failed"
json.isValid $jsonStr
test.assertTrue $ "Json.isValid failed"
log "Test 19 - Json module: All passed"

# Test 19a: obj command tests
obj
$emptyObj = $
test.assertType $emptyObj "object" "obj without args failed"
keys $emptyObj
$emptyKeys = $
array.length $emptyKeys
test.assertEqual $ 0 "obj empty object keys failed"

obj '{name: "John", age: 30}'
$objCreated = $
test.assertEqual $objCreated.name "John" "obj command basic creation failed"
test.assertEqual $objCreated.age 30 "obj command with number failed"

obj '{nested: {key: "value"}, array: [1, 2, 3]}'
$complexObj = $
test.assertEqual $complexObj.nested.key "value" "obj command nested object failed"
test.assertEqual $complexObj.array[0] 1 "obj command with array failed"

obj '{unquoted: "works", singleQuotes: "also works", numbers: 42, bool: true}'
$json5Obj = $
test.assertEqual $json5Obj.unquoted "works" "obj command unquoted keys failed"
test.assertEqual $json5Obj.singleQuotes "also works" "obj command single quotes failed"
test.assertEqual $json5Obj.numbers 42 "obj command number values failed"
test.assertEqual $json5Obj.bool true "obj command boolean values failed"

obj '{trailing: "comma", allowed: true,}'
$trailingComma = $
test.assertEqual $trailingComma.trailing "comma" "obj command trailing comma failed"
test.assertEqual $trailingComma.allowed true "obj command trailing comma value failed"

log "Test 19a - obj command: All passed"

# Test 19a2: array builtin tests
array
$emptyArray = $
array.length $emptyArray
test.assertEqual $ 0 "array without args failed"

array 1 2 3
$arr1 = $
array.length $arr1
test.assertEqual $ 3 "array command length failed"
test.assertEqual $arr1[0] 1 "array command first element failed"
test.assertEqual $arr1[1] 2 "array command second element failed"
test.assertEqual $arr1[2] 3 "array command third element failed"

array "hello" "world" 42 true
$mixedArray = $
array.length $mixedArray
test.assertEqual $ 4 "array command mixed types length failed"
test.assertEqual $mixedArray[0] "hello" "array command string element failed"
test.assertEqual $mixedArray[2] 42 "array command number element failed"
test.assertEqual $mixedArray[3] true "array command boolean element failed"

array 1 2 3 4 5
$numbers = $
math.add $numbers[0] $numbers[1]
test.assertEqual $ 3 "array command in expressions failed"

log "Test 19a2 - array command: All passed"

# Test 19b: Object module tests (get, set, keys, values, entries, merge, clone)
$testObj = $parsed
get $testObj "name"
test.assertEqual $ "John" "Object.get failed"
set $testObj "city" "NYC"
$setObj = $
get $setObj "city"
test.assertEqual $ "NYC" "Object.set failed"
keys $setObj
$keys = $
test.assertContains $keys "name" "Object.keys failed"
values $setObj
$values = $
test.assertContains $values "John" "Object.values failed"
json.parse '{"a": 1}'
$obj1 = $
json.parse '{"b": 2}'
$obj2 = $
merge $obj1 $obj2
$merged = $
get $merged "a"
test.assertEqual $ 1 "Object.merge failed"
get $merged "b"
test.assertEqual $ 2 "Object.merge failed"
clone $parsed
$cloned = $
get $cloned "name"
test.assertEqual $ "John" "Object.clone failed"
entries $cloned
$entries = $
test.assertNotNull $entries "Object.entries failed"
log "Test 19b - Object module: All passed"

# Test 20: Time module tests
time.now
$now = $
test.assertNotNull $now "Time.now failed"
test.assertType $now "string" "Time.now type failed"
time.timestamp
$ts = $
test.assertType $ts "number" "Time.timestamp type failed"
test.assertGreater $ts 0 "Time.timestamp value failed"
time.format "2024-01-15"
$formatted = $
test.assertType $formatted "string" "Time.format type failed"
time.addDays "2024-01-15T00:00:00.000Z" 7
$added = $
test.assertNotNull $added "Time.addDays failed"
time.diffDays "2024-01-01" "2024-01-08"
test.assertEqual $ 7 "Time.diffDays failed"
log "Test 20 - Time module: All passed"

# Test 21: Random module tests
random.int 1 10
$randInt = $
test.assertGreaterOrEqual $randInt 1 "Random.int min failed"
test.assertLessOrEqual $randInt 10 "Random.int max failed"
random.float
$randFloat = $
test.assertGreaterOrEqual $randFloat 0 "Random.float min failed"
test.assertLess $randFloat 1 "Random.float max failed"
random.uuid
$uuid = $
test.assertType $uuid "string" "Random.uuid type failed"
string.length $uuid
test.assertGreater $ 30 "Random.uuid length failed"
$arr = range 1 5
random.choice $arr
$choice = $
test.assertContains $arr $choice "Random.choice failed"
log "Test 21 - Random module: All passed"

# Test 22: Variable-to-variable assignment
$city = "New York"
log "Test 22 - Original city:" $city
$city2 = $city
test.assertEqual $city2 "New York" "Variable-to-variable assignment failed"
log "Test 22 - Assigned city:" $city2
$number1 = 42
$number2 = $number1
test.assertEqual $number2 42 "Number variable assignment failed"
$bool1 = true
$bool2 = $bool1
test.assertEqual $bool2 true "Boolean variable assignment failed"
log "Test 22 - Variable assignment: All passed"

# Test 23: Return statement in functions
def return_value
  return 100
  log "This should not execute"
enddef

return_value
test.assertEqual $ 100 "Function return value failed"

def return_variable
  $result = 200
  return $result
  log "This should not execute"
enddef

return_variable
test.assertEqual $ 200 "Function return variable failed"

def return_expression
  math.add 10 20
  return $
  log "This should not execute"
enddef

return_expression
test.assertEqual $ 30 "Function return expression failed"

def return_early
  if true
    return "early"
  endif
  log "This should not execute"
enddef

return_early
test.assertEqual $ "early" "Function early return failed"

def return_no_value
  $temp = 50
  return
  log "This should not execute"
enddef

return_no_value
test.assertEqual $ null "Function return last value failed"
log "Test 23 - Return in functions: All passed"

# Test 24: Return statement in global scope
# Note: We'll test this carefully since it terminates execution
# We'll create a separate test that can be run independently

def test_global_return
  $test_val = "global_return_test"
  return $test_val
  log "This should not execute"
enddef

# Test that return works in nested contexts
def outer_func
  def inner_func
    return "inner"
  enddef
  inner_func
  return $
enddef

outer_func
test.assertEqual $ "inner" "Nested function return failed"
log "Test 24 - Return in nested contexts: All passed"

# Test 25: Return with different value types
def return_string
  return "hello"
enddef

return_string
test.assertEqual $ "hello" "Return string failed"

def return_number
  return 42
enddef

return_number
test.assertEqual $ 42 "Return number failed"

def return_boolean
  return true
enddef

return_boolean
test.assertEqual $ true "Return boolean failed"

def return_null
  return null
enddef

return_null
test.assertEqual $ null "Return null failed"

def return_subexpression
  return $(math.add 5 5)
enddef

return_subexpression
test.assertEqual $ 10 "Return subexpression failed"
log "Test 25 - Return with different types: All passed"

# Test 26: Return in conditional blocks
def return_in_if
  if true
    return "if_return"
  endif
  return "after_if"
enddef

return_in_if
test.assertEqual $ "if_return" "Return in if block failed"

def return_in_else
  if false
    $temp = "if"
  else
    return "else_return"
  endif
  return "after_else"
enddef

return_in_else
test.assertEqual $ "else_return" "Return in else block failed"
log "Test 26 - Return in conditionals: All passed"

# Test 27: Return in loops
def return_in_for
  for $i in range 1 10
    if $i == 3
      return $i
    endif
  endfor
  return 0
enddef

return_in_for
test.assertEqual $ 3 "Return in for loop failed"
log "Test 27 - Return in loops: All passed"

# Test 28: Complex variable assignment scenarios
$original = "test"
$copy1 = $original
$copy2 = $copy1
test.assertEqual $copy2 "test" "Chained variable assignment failed"

$num1 = 10
$num2 = $num1
$num3 = $num2
math.add $num3 5
$result = $
test.assertEqual $result 15 "Variable assignment in expressions failed"

$arr1 = range 1 3
$arr2 = $arr1
array.length $arr2
test.assertEqual $ 3 "Array variable assignment failed"
log "Test 28 - Complex variable assignments: All passed"

# Test 29: assign command
$testVar = "original"
test.assertEqual $testVar "original" "Initial assignment failed"
assign $testVar "assigned"
test.assertEqual $testVar "assigned" "assign command failed"
assign $testVar 42
test.assertEqual $testVar 42 "assign command with number failed"
assign $testVar true
test.assertEqual $testVar true "assign command with boolean failed"
$sourceVar = "source value"
assign $testVar $sourceVar
test.assertEqual $testVar "source value" "assign command with variable failed"
math.add 10 20
assign $testVar $
test.assertEqual $testVar 30 "assign command with last value failed"

# Test assign with fallback (3rd parameter)
$emptyVar = null
assign $testVar $emptyVar "fallback value"
test.assertEqual $testVar "fallback value" "assign with fallback for null failed"

$emptyVar = ""
assign $testVar $emptyVar "fallback string"
test.assertEqual $testVar "fallback string" "assign with fallback for empty string failed"

$emptyVar = null
assign $testVar $emptyVar 42
test.assertEqual $testVar 42 "assign with fallback number failed"

$emptyVar = null
assign $testVar $emptyVar true
test.assertEqual $testVar true "assign with fallback boolean failed"

json.parse '[]'
$emptyVar = $
assign $testVar $emptyVar "fallback for empty array"
test.assertEqual $testVar "fallback for empty array" "assign with fallback for empty array failed"

$emptyVar = "not empty"
assign $testVar $emptyVar "fallback"
test.assertEqual $testVar "not empty" "assign should not use fallback when value is not empty"

$emptyVar = 0
assign $testVar $emptyVar "fallback"
test.assertEqual $testVar 0 "assign should not use fallback for zero"

$emptyVar = false
assign $testVar $emptyVar "fallback"
test.assertEqual $testVar false "assign should not use fallback for false"
log "Test 29 - assign command: All passed"

# Test 30: empty command
$toEmpty = "not empty"
test.assertEqual $toEmpty "not empty" "Variable before empty failed"
empty $toEmpty
test.assertEqual $toEmpty null "empty command failed"
$toEmpty = 42
test.assertEqual $toEmpty 42 "Variable reassignment after empty failed"
empty $toEmpty
test.assertEqual $toEmpty null "empty command second time failed"
$toEmpty = range 1 5
array.length $toEmpty
test.assertEqual $ 5 "Array before empty failed"
empty $toEmpty
test.assertEqual $toEmpty null "empty command with array failed"
log "Test 30 - empty command: All passed"

# Test 30b: fallback command
$maybeEmpty = null
fallback $maybeEmpty "default value"
test.assertEqual $ "default value" "fallback with null failed"

$maybeEmpty = ""
fallback $maybeEmpty "default string"
test.assertEqual $ "default string" "fallback with empty string failed"

$maybeEmpty = null
fallback $maybeEmpty 42
test.assertEqual $ 42 "fallback with number failed"

$maybeEmpty = null
fallback $maybeEmpty true
test.assertEqual $ true "fallback with boolean failed"

json.parse '[]'
$maybeEmpty = $
fallback $maybeEmpty "fallback for empty array"
test.assertEqual $ "fallback for empty array" "fallback with empty array failed"

$maybeEmpty = "not empty"
fallback $maybeEmpty "fallback"
test.assertEqual $ "not empty" "fallback should not use fallback when value is not empty"

$maybeEmpty = 0
fallback $maybeEmpty "fallback"
test.assertEqual $ 0 "fallback should not use fallback for zero"

$maybeEmpty = false
fallback $maybeEmpty "fallback"
test.assertEqual $ false "fallback should not use fallback for false"

$maybeEmpty = null
fallback $maybeEmpty
test.assertEqual $ null "fallback without fallback value should return null"

$hasValue = "Alice"
fallback $hasValue "Unknown"
test.assertEqual $ "Alice" "fallback should return variable value when not empty"
log "Test 30b - fallback command: All passed"

# Test 31: Comparison functions (isEqual, isBigger, isSmaller, isEqualOrBigger, isEqualOrSmaller)
# Test isEqual
test.isEqual 5 5
test.assertTrue $ "isEqual with equal numbers failed"
test.isEqual 5 3
test.assertFalse $ "isEqual with different numbers failed"
test.isEqual "hello" "hello"
test.assertTrue $ "isEqual with equal strings failed"
test.isEqual "hello" "world"
test.assertFalse $ "isEqual with different strings failed"
test.isEqual true true
test.assertTrue $ "isEqual with equal booleans failed"
test.isEqual true false
test.assertFalse $ "isEqual with different booleans failed"
test.isEqual null null
test.assertTrue $ "isEqual with null values failed"
$arr1 = range 1 3
$arr2 = range 1 3
test.isEqual $arr1 $arr2
test.assertTrue $ "isEqual with equal arrays failed"
log "Test 31a - isEqual: All passed"

# Test isBigger
test.isBigger 10 5
test.assertTrue $ "isBigger with 10 > 5 failed"
test.isBigger 5 10
test.assertFalse $ "isBigger with 5 > 10 failed"
test.isBigger 5 5
test.assertFalse $ "isBigger with 5 > 5 failed"
test.isBigger -5 -10
test.assertTrue $ "isBigger with negative numbers failed"
log "Test 31b - isBigger: All passed"

# Test isSmaller
test.isSmaller 3 5
test.assertTrue $ "isSmaller with 3 < 5 failed"
test.isSmaller 5 3
test.assertFalse $ "isSmaller with 5 < 3 failed"
test.isSmaller 5 5
test.assertFalse $ "isSmaller with 5 < 5 failed"
test.isSmaller -10 -5
test.assertTrue $ "isSmaller with negative numbers failed"
log "Test 31c - isSmaller: All passed"

# Test isEqualOrBigger
test.isEqualOrBigger 10 5
test.assertTrue $ "isEqualOrBigger with 10 >= 5 failed"
test.isEqualOrBigger 5 5
test.assertTrue $ "isEqualOrBigger with 5 >= 5 failed"
test.isEqualOrBigger 3 5
test.assertFalse $ "isEqualOrBigger with 3 >= 5 failed"
test.isEqualOrBigger -5 -10
test.assertTrue $ "isEqualOrBigger with negative numbers failed"
log "Test 31d - isEqualOrBigger: All passed"

# Test isEqualOrSmaller
test.isEqualOrSmaller 3 5
test.assertTrue $ "isEqualOrSmaller with 3 <= 5 failed"
test.isEqualOrSmaller 5 5
test.assertTrue $ "isEqualOrSmaller with 5 <= 5 failed"
test.isEqualOrSmaller 10 5
test.assertFalse $ "isEqualOrSmaller with 10 <= 5 failed"
test.isEqualOrSmaller -10 -5
test.assertTrue $ "isEqualOrSmaller with negative numbers failed"
log "Test 31e - isEqualOrSmaller: All passed"

# Test comparison functions in conditionals
$value = 10
if test.isBigger $value 5
  $result = "bigger"
else
  $result = "not bigger"
endif
test.assertEqual $result "bigger" "isBigger in conditional failed"

if test.isSmaller $value 5
  $result = "smaller"
else
  $result = "not smaller"
endif
test.assertEqual $result "not smaller" "isSmaller in conditional failed"

if test.isEqual $value 10
  $result = "equal"
else
  $result = "not equal"
endif
test.assertEqual $result "equal" "isEqual in conditional failed"

if test.isEqualOrBigger $value 10
  $result = "equal or bigger"
else
  $result = "not equal or bigger"
endif
test.assertEqual $result "equal or bigger" "isEqualOrBigger in conditional failed"

if test.isEqualOrSmaller $value 10
  $result = "equal or smaller"
else
  $result = "not equal or smaller"
endif
test.assertEqual $result "equal or smaller" "isEqualOrSmaller in conditional failed"
log "Test 31f - Comparison functions in conditionals: All passed"

log "Test 31 - Comparison functions: All passed"

# Test 32: Subexpressions $( )
# Test basic single-line subexpression
$test1 = $(math.add 5 3)
test.assertEqual $test1 8 "Basic subexpression failed"

# Test subexpression with multiple operations
$test2 = $(math.add 10 5)
$test3 = $(math.multiply $test2 2)
test.assertEqual $test3 30 "Subexpression with variable reference failed"

# Test nested subexpressions
$test4 = $(math.add $(math.multiply 2 3) $(math.add 1 1))
test.assertEqual $test4 8 "Nested subexpression failed"

# Test multi-line subexpression
$test5 = $(
  math.add 10 20
)
test.assertEqual $test5 30 "Multi-line subexpression failed"

# Test multi-line subexpression with nested subexpression
# Note: $test2 is 15 at this point. The nested subexpression $(assign $test2 1) 
# sets $test2 to 1 and returns 1, but $test2 is evaluated first (as 15) before 
# the nested subexpression runs, so result is 15 * 1 = 15
$test6 = $(
  math.multiply $test2 $(assign $test2 1)
)

test.assertEqual $test6 15 "Multi-line subexpression with nested subexpression failed"
test.assertEqual $test2 1 "Nested assign in subexpression failed"

# Test complex multi-line subexpression
$test7 = $(
  math.add 5 5
  math.multiply $ 3
)
test.assertEqual $test7 30 "Complex multi-line subexpression failed"

# Test subexpression in function call
math.add $(math.multiply 2 5) $(math.add 3 2)
test.assertEqual $ 15 "Subexpression in function call failed"

# Test subexpression in conditional
if $(math.add 5 5) == 10
  $test8 = "passed"
else
  $test8 = "failed"
endif

test.assertEqual $test8 "passed" "Subexpression in conditional failed"

# Test subexpression with string operations
$test9 = $(string.concat "hello" " " "world")
test.assertEqual $test9 "hello world" "Subexpression with string operations failed"

# Test subexpression with array operations
$test10 = $(array.create 1 2 3)
array.length $test10
test.assertEqual $ 3 "Subexpression with array operations failed"

# Test deeply nested subexpressions
$test11 = $(math.add $(math.multiply $(math.add 1 1) 2) $(math.add 1 1))
test.assertEqual $test11 6 "Deeply nested subexpression failed"

# Test subexpression with return value
def test_subexpr_return
  return $(math.add 10 20)
enddef
test_subexpr_return
test.assertEqual $ 30 "Subexpression in return statement failed"

# Test multi-line subexpression with multiple statements
$test12 = $(
  math.add 1 2
  math.multiply $ 2
  math.add $ 1
)
test.assertEqual $test12 7 "Multi-line subexpression with multiple statements failed"

# Test subexpression with variable assignment inside (modifies parent scope)
$testVar = 10  # Set initial value in parent scope
$test13 = $(
  assign $testVar 42  # This should modify the parent $testVar
  math.add $testVar 8
)

test.assertEqual $test13 50 "Subexpression with variable assignment failed"
test.assertEqual $testVar 42 "Variable assignment in subexpression should modify parent scope"

log "Test 32 - Subexpressions $( ): All passed"

# Test 33: Attribute access and array indexing
# Test basic property access
json.parse '{"name": "John", "age": 30, "address": {"city": "NYC", "zip": 10001}}'
$user = $
test.assertEqual $user.name "John" "Basic property access failed"
test.assertEqual $user.age 30 "Basic property access with number failed"
test.assertEqual $user.address.city "NYC" "Nested property access failed"
test.assertEqual $user.address.zip 10001 "Nested property access with number failed"

# Test array indexing
$arr = range 10 15
test.assertEqual $arr[0] 10 "Array index 0 failed"
test.assertEqual $arr[2] 12 "Array index 2 failed"
test.assertEqual $arr[5] 15 "Array index 5 failed"
test.assertEqual $arr[10] null "Out of bounds array access should return null"

# Test combined property and array access
json.parse '{"items": [{"name": "item1", "price": 10}, {"name": "item2", "price": 20}]}'
$data = $
test.assertEqual $data.items[0].name "item1" "Combined property and array access failed"
test.assertEqual $data.items[0].price 10 "Combined property and array access with number failed"
test.assertEqual $data.items[1].name "item2" "Combined property and array access second item failed"

# Test property access in expressions
if $user.age >= 30
  $isAdult = true
else
  $isAdult = false
endif
test.assertEqual $isAdult true "Property access in conditional expression failed"

# Test array access in expressions
if $arr[0] == 10
  $firstIsTen = true
else
  $firstIsTen = false
endif
test.assertEqual $firstIsTen true "Array access in conditional expression failed"

# Test property access in function calls
math.add $user.age 5
test.assertEqual $ 35 "Property access as function argument failed"

# Test array access in function calls
math.add $arr[0] $arr[1]
test.assertEqual $ 21 "Array access as function arguments failed"

# Note: Error cases (accessing property of null, indexing non-array, etc.) are tested manually
# as they throw exceptions that would terminate test execution

# Test property access in variable assignment
$name = $user.name
test.assertEqual $name "John" "Property access in variable assignment failed"

# Test array access in variable assignment
$firstItem = $arr[0]
test.assertEqual $firstItem 10 "Array access in variable assignment failed"

# Test nested property access in variable assignment
$city = $user.address.city
test.assertEqual $city "NYC" "Nested property access in variable assignment failed"

# Test combined access in variable assignment
$itemName = $data.items[0].name
test.assertEqual $itemName "item1" "Combined access in variable assignment failed"

log "Test 33 - Attribute access and array indexing: All passed"

# Test 34: Assignment to attribute paths and array indices
# Test assignment to property path
json.parse '{"name": "John", "age": 30}'
$user = $
$user.city = "London"
test.assertEqual $user.city "London" "Assignment to property path failed"
test.assertEqual $user.name "John" "Assignment to property path should preserve other properties"

# Test assignment to nested property path
$user.address.city = "NYC"
test.assertEqual $user.address.city "NYC" "Assignment to nested property path failed"
test.assertEqual $user.name "John" "Assignment to nested property path should preserve other properties"

# Test assignment to array index
$arr = range 1 5
$arr[0] = 100
test.assertEqual $arr[0] 100 "Assignment to array index failed"
test.assertEqual $arr[1] 2 "Assignment to array index should preserve other elements"

# Test assignment to nested array index
json.parse '{"items": [10, 20, 30]}'
$data = $
$data.items[0] = 100
test.assertEqual $data.items[0] 100 "Assignment to nested array index failed"
test.assertEqual $data.items[1] 20 "Assignment to nested array index should preserve other elements"

# Test assignment to combined path
json.parse '{"items": [{"name": "item1", "price": 10}]}'
$data = $
$data.items[0].price = 50
test.assertEqual $data.items[0].price 50 "Assignment to combined path failed"
test.assertEqual $data.items[0].name "item1" "Assignment to combined path should preserve other properties"

# Test assignment creates intermediate objects
$animal.cat = 5
test.assertEqual $animal.cat 5 "Assignment creating intermediate object failed"

# Test assignment creates nested intermediate objects
$config.database.host = "localhost"
test.assertEqual $config.database.host "localhost" "Assignment creating nested intermediate objects failed"

# Test assignment to last value with property path
json.parse '{"name": "John"}'
$.age = 30

scope 
  test.assertEqual $.name "John" "Last value property access failed"
endscope

scope
  test.assertEqual $.age 30 "Assignment to last value property path failed"
endscope

test.assertEqual $.name "John" "Assignment to last value property path should preserve other properties"

# Test assignment to last value with array index
range 1 5
$[0] = 100

scope
  test.assertEqual $[0] 100 "Assignment to last value array index failed"
endscope

scope
  test.assertEqual $[1] 2 "Assignment to last value array index should preserve other elements"
endscope

# Test assignment to last value with nested path
json.parse '{"user": {"name": "John"}}'
$.user.city = "Paris"
scope
  test.assertEqual $.user.city "Paris" "Assignment to last value nested path failed"
endscope

scope
  test.assertEqual $.user.name "John" "Assignment to last value nested path should preserve other properties"
endscope

# Test assignment to last value creates intermediate objects
json.parse '{}'
$.settings.theme = "dark"

scope
  test.assertEqual $.settings.theme "dark" "Assignment to last value creating intermediate object failed"
endscope

# Test assignment to array index out of bounds (should extend array)
$arr = range 1 3
$arr[5] = 100
test.assertEqual $arr[5] 100 "Assignment to out of bounds array index failed"
array.length $arr
test.assertEqual $ 6 "Assignment to out of bounds array index should extend array"

# Test assignment to new property on existing object
$user = $parsed
$user.email = "john@example.com"
test.assertEqual $user.email "john@example.com" "Assignment to new property on existing object failed"
test.assertEqual $user.name "John" "Assignment to new property should preserve existing properties"

# Test assignment overwrites existing property
$user.age = 25
test.assertEqual $user.age 25 "Assignment overwriting existing property failed"

# Test assignment to multiple nested paths
$config.api.url = "https://api.example.com"
$config.api.timeout = 30
test.assertEqual $config.api.url "https://api.example.com" "Multiple assignments to nested path failed"
test.assertEqual $config.api.timeout 30 "Multiple assignments to nested path second property failed"

# Test assignment with assign command to attribute path
assign $user.city "Tokyo"
test.assertEqual $user.city "Tokyo" "assign command with attribute path failed"

# Test assignment with assign command to array index
assign $arr[0] 200
test.assertEqual $arr[0] 200 "assign command with array index failed"

# Test assignment with assign command to last value attribute path
json.parse '{"name": "Alice"}'
$
assign $.age 25
test.assertEqual $.age 25 "assign command with last value attribute path failed"

log "Test 34 - Assignment to attribute paths and array indices: All passed"

# Test 35: Break statement in for loops
# Test basic break
$breakTest = 0
for $i in range 1 10
  if $i == 5
    break
  endif
  assign $breakTest $i
endfor
test.assertEqual $breakTest 4 "Basic break statement failed"

# Test break in nested loops (should only break inner loop)
$outerCount = 0
$innerCount = 0
for $i in range 1 3
  assign $outerCount $i
  for $j in range 1 5
    if $j == 3
      break
    endif
    assign $innerCount $j
  endfor
endfor
test.assertEqual $outerCount 3 "Break in nested loop - outer loop failed"
test.assertEqual $innerCount 2 "Break in nested loop - inner loop failed"

# Test break with condition
$found = false
for $i in range 1 10
  if $i == 7
    assign $found true
    break
  endif
endfor
test.assertEqual $found true "Break with condition failed"

# Test break early in loop
$earlyBreak = 0
for $i in range 1 10
  if $i == 1
    break
  endif
  assign $earlyBreak $i
endfor
test.assertEqual $earlyBreak 0 "Early break failed"

# Test break after some iterations
$iterations = 0
for $i in range 1 10
  assign $iterations $i
  if $i == 3
    break
  endif
endfor
test.assertEqual $iterations 3 "Break after iterations failed"

# Test break preserves last value
for $i in range 1 5
  if $i == 3
    break
  endif
endfor
test.assertEqual $ 3 "Break preserves last value failed"

log "Test 35 - Break statement: All passed"

# Test 36: Range with step parameter
# Test positive step counting up
range 0 5 1
$range1 = $
test.assertEqual $range1[0] 0 "Range with step 1 - first element failed"
test.assertEqual $range1[5] 5 "Range with step 1 - last element failed"
array.length $range1
test.assertEqual $ 6 "Range with step 1 - length failed"

# Test positive step counting up with larger step
range 0 10 2
$range2 = $
test.assertEqual $range2[0] 0 "Range with step 2 - first element failed"
test.assertEqual $range2[1] 2 "Range with step 2 - second element failed"
test.assertEqual $range2[5] 10 "Range with step 2 - last element failed"
array.length $range2
test.assertEqual $ 6 "Range with step 2 - length failed"

# Test negative step counting down
range 5 0 -1
$range3 = $
test.assertEqual $range3[0] 5 "Range with step -1 - first element failed"
test.assertEqual $range3[5] 0 "Range with step -1 - last element failed"
array.length $range3
test.assertEqual $ 6 "Range with step -1 - length failed"

# Test negative step counting down with larger step
range 10 0 -2
$range4 = $
test.assertEqual $range4[0] 10 "Range with step -2 - first element failed"
test.assertEqual $range4[1] 8 "Range with step -2 - second element failed"
test.assertEqual $range4[5] 0 "Range with step -2 - last element failed"
array.length $range4
test.assertEqual $ 6 "Range with step -2 - length failed"

# Test range with step when start > end (positive step should produce empty or count down)
# Note: With positive step and start > end, the loop condition i <= end is false from start, so empty array
range 5 0 1
$range5 = $
array.length $range5
test.assertEqual $ 0 "Range 5 0 1 should produce empty array (positive step can't count down)"

# Test range with step when start < end (negative step should produce empty)
range 0 5 -1
$range6 = $
array.length $range6
test.assertEqual $ 0 "Range 0 5 -1 should produce empty array (negative step can't count up)"

# Test range with negative numbers
range -5 0 1
$range7 = $
test.assertEqual $range7[0] -5 "Range -5 0 1 - first element failed"
test.assertEqual $range7[5] 0 "Range -5 0 1 - last element failed"
array.length $range7
test.assertEqual $ 6 "Range -5 0 1 - length failed"

# Test range with negative step and negative numbers
range 0 -5 -1
$range8 = $
test.assertEqual $range8[0] 0 "Range 0 -5 -1 - first element failed"
test.assertEqual $range8[5] -5 "Range 0 -5 -1 - last element failed"
array.length $range8
test.assertEqual $ 6 "Range 0 -5 -1 - length failed"

log "Test 36 - Range with step parameter: All passed"

log "All tests completed!"

